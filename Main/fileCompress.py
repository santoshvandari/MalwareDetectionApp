import os
import zlib
import zipfile
from core.settings import MEDIA_ROOT

def compress_file_to_zip(filename):
    if not filename:
        return False
    
    filepath = os.path.join(MEDIA_ROOT, 'UploadFiles', filename)
    if not os.path.exists(filepath):
        return False

    # Define the path for the compressed ZIP file
    compressed_dir = os.path.join(MEDIA_ROOT, 'CompressedFiles')
    
    # Ensure the directory exists
    if not os.path.exists(compressed_dir):
        os.makedirs(compressed_dir)
    
    compressed_filepath = os.path.join(compressed_dir, f"{filename}.zip")

    try:
        # Read the file content
        with open(filepath, 'rb') as file:
            file_content = file.read()
        
        # Compress the content using zlib (Deflate algorithm)
        compressed_content = zlib.compress(file_content, level=9)
        
        # Write the compressed content to a ZIP file
        with zipfile.ZipFile(compressed_filepath, 'w', zipfile.ZIP_DEFLATED) as zipf:
            zipf.writestr(os.path.basename(filename), compressed_content)
        return f"{filename}.zip"
    
    except Exception as e:
        print(f"An error occurred while compressing the file: {e}")
        return False
